import { CommonModule } from '@angular/common';
import { Component, inject } from '@angular/core';
import { FormBuilder, FormControl, FormGroup, ReactiveFormsModule } from '@angular/forms';
import { Router, RouterLink } from '@angular/router';
import { CheckboxModule } from 'primeng/checkbox';
import { InputTextModule } from 'primeng/inputtext';
import { AppleWidget } from '@/pages/auth/components/applewidget';
import { GoogleWidget } from '@/pages/auth/components/googlewidget';
import { LazyImageWidget } from '@/layout/notfound/lazyimagewidget';
import { LogoWidget } from '@/layout/notfound/logowidget';
import { LoginUsuario } from '@/model/login-usuario';
import { TokenService } from '@/shared/service/auth/token.service';
import { AuthService } from '@/shared/service/auth/auth.service';
import { MessageService } from 'primeng/api';

@Component({
    selector: 'app-login',
    standalone: true,
    imports: [LogoWidget, CommonModule, ReactiveFormsModule, InputTextModule, LazyImageWidget, GoogleWidget, AppleWidget, CheckboxModule, RouterLink],
    template: `
        <section class="min-h-screen flex items-center lg:items-start lg:py-20 justify-center animate-fadein animate-duration-300 animate-ease-in max-w-400 mx-auto">
            <div class="flex w-full h-full justify-center gap-12">
                <div class="flex flex-col py-20 lg:min-w-120">
                    <a routerLink="/" class="flex items-center justify-center lg:justify-start mb-8">
                        <logo-widget></logo-widget>
                    </a>
                    <div class="flex flex-col justify-center grow">
                        <div class="max-w-md mx-auto w-full">
                            <h5 class="title-h5 text-center lg:text-left">Login</h5>
                            <p class="body-small mt-3.5 text-center lg:text-left">Please enter your details</p>
                            <button class="social-button mt-8"><app-google-widget></app-google-widget> Sign in with Google</button>
                            <button class="social-button mt-4"><app-apple-widget></app-apple-widget> Sign in with Apple</button>
                            <div class="flex items-center gap-3.5 my-7">
                                <span class="flex-1 h-px bg-surface-200 dark:bg-surface-800"></span>
                                <span class="body-small text-surface-400 dark:text-surface-600">or</span>
                                <span class="flex-1 h-px bg-surface-200 dark:bg-surface-800"></span>
                            </div>
                            <form [formGroup]="loginForm" (ngSubmit)="onLogin()">
                                <input type="text" formControlName="correo" pInputText class="w-full" placeholder="Correo" required />
                                <input type="contrasena" formControlName="contrasena" pInputText class="w-full mt-4" placeholder="Contrasena" required />
                                <div class="my-8 flex items-center justify-between">
                                    <div class="flex items-center gap-2">
                                        <p-checkbox inputId="remember" formControlName="remember" [binary]="true" />
                                        <label for="remember" class="body-small">Remember me</label>
                                    </div>
                                    <a routerLink="/auth/forgot-password" class="body-small text-primary-500 hover:underline">Forgot password?</a>
                                </div>
                                <button type="submit" class="body-button w-full" on>Login</button>
                            </form>
                            <div class="mt-8 body-small text-center lg:text-left">Not registered? <a routerLink="/auth/register" class="text-primary-500 hover:underline">Create an Account</a></div>
                        </div>
                    </div>
                    <div class="mt-8 text-center lg:text-start block relative text-surface-400 dark:text-surface-500 text-sm">©{{ currentYear }} PrimeTek</div>
                </div>
                <div class="hidden lg:flex h-full py-20">
                    <div class="h-full w-full lg:max-w-130 xl:max-w-242 mx-auto flex items-center justify-center shadow-[0px_1px_2px_0px_rgba(18,18,23,0.05)] rounded-3xl border border-surface overflow-hidden">
                        <app-lazy-image-widget className="w-auto h-full object-contain object-left" src="/demo/images/landing/auth-image.svg" alt="Auth Image" />
                    </div>
                </div>
            </div>
        </section>
    `,
})
export class Login {

    private messageService = inject(MessageService);
    loginUsuario: LoginUsuario;
    roles: string[] = [];

    loginForm: FormGroup;
    currentYear: number = new Date().getFullYear();

    constructor(private fb: FormBuilder, private tokenService: TokenService, private authService: AuthService,
        private router: Router) {
        this.loginForm = this.fb.group({
            correo: [''],
            contrasena: [''],
            remember: [false]
        });
        this.loginUsuario = new LoginUsuario('', '');
    }


    onLogin() {

        this.loginUsuario = new LoginUsuario(this.correo.value, this.contrasena.value);
        this.authService.login(this.loginUsuario).subscribe({

            next: data => {

                this.tokenService.setToken(data.token);


                let rol = this.tokenService.getRoles().toString();


                switch (rol) {

                    case 'ADMINISTRADOR':
                        this.router.navigate(['/inicio']);
                        break;

                    case 'COMUNICACION':
                        this.router.navigate(['/comunicacion/infraestructura']);
                        break;

                    default:
                        this.router.navigate(['/superior/tablero'])
                        break;
                }
                this.messageService.add({ severity: 'success', summary: 'Acceso Correcto', detail: "Inicio de sesión correcto", life: 3000 });

            }, error: (error) => {

                this.messageService.add({ severity: 'error', summary: 'Acceso Incorrecto', detail: '', life: 3000 });
                this.router.navigate([''])
            }
        });
    }

    get correo() {
        return this.loginForm.get('correo') as FormControl;
    }

    get contrasena() {
        return this.loginForm.get('contrasena') as FormControl;
    }
}
